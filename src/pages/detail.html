<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>전시 상세</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
      background-color: #f7f8fa;
      line-height: 1.6;
    }
    
    /* 헤더 */
    .header {
      background: white;
      border-bottom: 1px solid #e5e8eb;
      padding: 15px 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .back-btn {
      display: inline-flex;
      align-items: center;
      color: #333;
      text-decoration: none;
      font-size: 15px;
      font-weight: 500;
    }
    
    .back-btn:hover {
      color: #03c75a;
    }
    
    /* 컨테이너 */
    .container {
      max-width: 768px;
      margin: 0 auto;
    }
    
    /* 전시 헤더 */
    .exhibition-header {
      background: white;
      padding: 24px 20px;
    }
    
    .exhibition-title {
      font-size: 24px;
      font-weight: 700;
      color: #333;
      margin-bottom: 8px;
    }
    
    .exhibition-subtitle {
      font-size: 15px;
      color: #666;
      margin-bottom: 16px;
    }
    
    /* 평점 요약 */
    .rating-box {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 16px 0;
      border-top: 1px solid #f2f4f6;
      border-bottom: 1px solid #f2f4f6;
    }
    
    .rating-score {
      font-size: 32px;
      font-weight: 700;
      color: #03c75a;
    }
    
    .rating-stars {
      font-size: 20px;
      color: #ffc107;
    }
    
    .rating-count {
      font-size: 14px;
      color: #666;
    }
    
    /* 정보 섹션 */
    .info-section {
      background: white;
      margin-top: 8px;
      padding: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #333;
      margin-bottom: 16px;
    }
    
    .info-item {
      display: flex;
      padding: 12px 0;
      border-bottom: 1px solid #f2f4f6;
    }
    
    .info-item:last-child {
      border-bottom: none;
    }
    
    .info-label {
      min-width: 80px;
      font-size: 14px;
      color: #666;
    }
    
    .info-value {
      flex: 1;
      font-size: 14px;
      color: #333;
      line-height: 1.6;
    }
    
    .info-value a {
      color: #03c75a;
      text-decoration: none;
    }
    
    /* 리뷰 섹션 */
    .review-section {
      background: white;
      margin-top: 8px;
      padding: 20px;
    }
    
    .review-write-btn {
      width: 100%;
      padding: 14px;
      background: #03c75a;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 24px;
    }
    
    .review-write-btn:hover {
      background: #02b350;
    }
    
    /* 리뷰 작성 폼 */
    .review-form {
      display: none;
      background: #f7f8fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 24px;
    }
    
    .review-form.active {
      display: block;
    }
    
    .form-group {
      margin-bottom: 16px;
    }
    
    .form-label {
      display: block;
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }
    
    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: 12px;
      border: 1px solid #e5e8eb;
      border-radius: 6px;
      font-size: 14px;
      font-family: inherit;
    }
    
    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: #03c75a;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .form-buttons {
      display: flex;
      gap: 8px;
    }
    
    .btn-submit,
    .btn-cancel {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .btn-submit {
      background: #03c75a;
      color: white;
    }
    
    .btn-submit:hover {
      background: #02b350;
    }
    
    .btn-cancel {
      background: #f2f4f6;
      color: #666;
    }
    
    .btn-cancel:hover {
      background: #e5e8eb;
    }
    
    /* 리뷰 리스트 */
    .review-list {
      margin-top: 24px;
    }
    
    .review-item {
      padding: 20px 0;
      border-bottom: 1px solid #f2f4f6;
    }
    
    .review-item:last-child {
      border-bottom: none;
    }
    
    .review-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .review-user {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .review-avatar {
      width: 32px;
      height: 32px;
      background: #03c75a;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }
    
    .review-name {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .review-rating {
      color: #ffc107;
      font-size: 14px;
    }
    
    .review-date {
      font-size: 13px;
      color: #999;
    }
    
    .review-comment {
      font-size: 14px;
      color: #333;
      line-height: 1.6;
      margin-top: 8px;
    }
    
    .empty-reviews {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }
    
    .error-box {
      background: #fff3f3;
      color: #d32f2f;
      padding: 16px;
      border-radius: 8px;
      margin: 20px;
    }
    
    /* 태그 */
    .tag {
      display: inline-block;
      padding: 4px 10px;
      background: #f2f4f6;
      color: #666;
      border-radius: 4px;
      font-size: 12px;
      margin-right: 6px;
      margin-bottom: 6px;
    }
    
    .tag.primary {
      background: #e8f5e9;
      color: #2e7d32;
    }
  </style>
</head>
<body>
  <div class="header">
    <a href="/" class="back-btn">← 전시 목록</a>
  </div>

  <div class="container">
    <div id="exhibition-content" class="loading">
      로딩 중...
    </div>
  </div>

  <script>
    // ========== 전역 변수 ==========
    let currentExhibition = null;
    
    // ========== 유틸 함수 (먼저 정의) ==========
    function formatDate(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}.${month}.${day}`;
    }
    
    function formatDateTime(dateString) {
      const date = new Date(dateString);
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}.${month}.${day}`;
    }
    
    function formatPrice(price) {
      return price === 0 ? '무료' : `${price.toLocaleString()}원`;
    }
    
    function getStars(rating) {
      return '⭐'.repeat(rating);
    }
    
    function getInitial(name) {
      return name.charAt(0);
    }
    
    function getExhibitionId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id');
    }
    
    // ========== API 호출 ==========
    async function fetchExhibition(id) {
      const response = await fetch(`/api/exhibitions/${id}`);
      if (!response.ok) throw new Error('전시 정보를 불러올 수 없습니다');
      return await response.json();
    }
    
    async function fetchReviews(exhibitionId) {
      const response = await fetch(`/api/reviews/exhibition/${exhibitionId}`);
      if (!response.ok) throw new Error('리뷰를 불러올 수 없습니다');
      return await response.json();
    }
    
    async function submitReview(data) {
      const response = await fetch('/api/reviews', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      if (!response.ok) throw new Error('리뷰 등록에 실패했습니다');
      return await response.json();
    }
    
    // ========== 렌더링 함수 ==========
    function renderExhibition(exh) {
      currentExhibition = exh;
      
      const barrierFreeTags = [];
      if (exh.barrierFree.wheelchair) barrierFreeTags.push('휠체어');
      if (exh.barrierFree.elevator) barrierFreeTags.push('엘리베이터');
      if (exh.barrierFree.braille) barrierFreeTags.push('점자안내');
      if (exh.barrierFree.audioGuide) barrierFreeTags.push('오디오가이드');
      
      // 평점 표시 로직
      let ratingHTML = '';
      if (exh.displayRating) {
        ratingHTML = `
          <div class="rating-box">
            <span class="rating-score">${exh.displayRating.rating.toFixed(1)}</span>
            <div>
              <div class="rating-stars">${getStars(Math.round(exh.displayRating.rating))}</div>
              <div class="rating-count">${exh.displayRating.label} · ${exh.displayRating.count}개 리뷰</div>
            </div>
          </div>
        `;
      } else {
        ratingHTML = `
          <div class="rating-box">
            <div style="color: #999; font-size: 14px;">
              아직 리뷰가 없습니다
            </div>
          </div>
        `;
      }
      
      const periodText = exh.periodUnknown || !exh.period?.start || !exh.period?.end
        ? '기간 미정'
        : `${formatDate(exh.period.start)} ~ ${formatDate(exh.period.end)}`;

      const html = `
        <div class="exhibition-header">
          <h1 class="exhibition-title">${exh.title}</h1>
          <p class="exhibition-subtitle">${exh.venue?.name || '전시장'}</p>
          ${ratingHTML}
        </div>
        
        <div class="info-section">
          <h2 class="section-title">상세 정보</h2>
          
          <div class="info-item">
            <span class="info-label">위치</span>
            <span class="info-value">${exh.venue?.address || ''}</span>
          </div>
          
          <div class="info-item">
            <span class="info-label">기간</span>
            <span class="info-value">${periodText}</span>
          </div>
          
          ${exh.openHours ? `
            <div class="info-item">
              <span class="info-label">운영시간</span>
              <span class="info-value">
                평일 ${exh.openHours.weekday || '-'}<br>
                주말 ${exh.openHours.weekend || '-'}<br>
                ${exh.openHours.closed && exh.openHours.closed.length > 0 ? `휴관: ${exh.openHours.closed.join(', ')}` : ''}
              </span>
            </div>
          ` : ''}
          
          <div class="info-item">
            <span class="info-label">관람료</span>
            <span class="info-value">
              성인 ${formatPrice(exh.price.adult)} / 청소년 ${formatPrice(exh.price.youth)} / 어린이 ${formatPrice(exh.price.child)}
            </span>
          </div>
          
          ${exh.artists && exh.artists.length > 0 ? `
            <div class="info-item">
              <span class="info-label">작가</span>
              <span class="info-value">${exh.artists.join(', ')}</span>
            </div>
          ` : ''}
          
          ${exh.website ? (() => {
            const urls = exh.website.split('\n').map(u => u.trim()).filter(Boolean);
            const official = urls[0] || '';
            const source = urls[1] || '';
            return `
            <div class="info-item">
              <span class="info-label">웹사이트</span>
              <span class="info-value">
                <a href="${official}" target="_blank">공식 홈페이지 →</a>
                ${source ? `<br><a href="${source}" target="_blank" style="color:#666;">상세 정보 →</a>` : ''}
              </span>
            </div>
            `;
          })() : ''}
          
          ${barrierFreeTags.length > 0 ? `
            <div class="info-item">
              <span class="info-label">편의시설</span>
              <span class="info-value">
                ${barrierFreeTags.map(tag => `<span class="tag primary">${tag}</span>`).join('')}
              </span>
            </div>
          ` : ''}
        </div>
        
        ${exh.description ? `
          <div class="info-section">
            <h2 class="section-title">전시 소개</h2>
            <p class="info-value">${exh.description}</p>
          </div>
        ` : ''}
        
        <div class="review-section">
          <h2 class="section-title">리뷰</h2>
          
          <button class="review-write-btn" onclick="toggleReviewForm()">
            리뷰 작성하기
          </button>
          
          <form class="review-form" id="reviewForm" onsubmit="handleSubmitReview(event)">
            <div class="form-group">
              <label class="form-label">닉네임 (선택)</label>
              <input type="text" class="form-input" id="userName" placeholder="익명">
            </div>
            
            <div class="form-group">
              <label class="form-label">평점 *</label>
              <select class="form-select" id="rating" required>
                <option value="">선택하세요</option>
                <option value="5">⭐⭐⭐⭐⭐ 최고예요</option>
                <option value="4">⭐⭐⭐⭐ 좋아요</option>
                <option value="3">⭐⭐⭐ 괜찮아요</option>
                <option value="2">⭐⭐ 별로예요</option>
                <option value="1">⭐ 아쉬워요</option>
              </select>
            </div>
            
            <div class="form-group">
              <label class="form-label">후기 *</label>
              <textarea class="form-textarea" id="comment" placeholder="전시를 관람한 솔직한 후기를 남겨주세요" required></textarea>
            </div>
            
            <div class="form-buttons">
              <button type="button" class="btn-cancel" onclick="toggleReviewForm()">취소</button>
              <button type="submit" class="btn-submit">등록</button>
            </div>
          </form>
          
          <div id="reviewList" class="review-list"></div>
        </div>
      `;
      
      document.getElementById('exhibition-content').innerHTML = html;
    }
    
    function renderReviews(reviews) {
      const container = document.getElementById('reviewList');
      
      if (reviews.length === 0) {
        container.innerHTML = '<div class="empty-reviews">아직 리뷰가 없습니다.<br>첫 리뷰를 작성해보세요!</div>';
        return;
      }
      
      container.innerHTML = reviews.map(review => `
        <div class="review-item">
          <div class="review-header">
            <div class="review-user">
              <div class="review-avatar">${getInitial(review.userName)}</div>
              <span class="review-name">${review.userName}</span>
            </div>
            <span class="review-rating">${getStars(review.rating)}</span>
          </div>
          <p class="review-comment">${review.comment}</p>
          <div class="review-date">${formatDateTime(review.createdAt)}</div>
        </div>
      `).join('');
    }
    
    // ========== 이벤트 핸들러 ==========
    function toggleReviewForm() {
      const form = document.getElementById('reviewForm');
      form.classList.toggle('active');
    }
    
    async function handleSubmitReview(e) {
      e.preventDefault();
      
      const userName = document.getElementById('userName').value || '익명';
      const rating = parseInt(document.getElementById('rating').value);
      const comment = document.getElementById('comment').value;
      
      try {
        await submitReview({
          exhibitionId: currentExhibition._id,
          userName,
          rating,
          comment
        });
        
        alert('리뷰가 등록되었습니다!');
        
        document.getElementById('reviewForm').reset();
        toggleReviewForm();
        
        await loadData();
        
      } catch (error) {
        alert('리뷰 등록 실패: ' + error.message);
      }
    }
    
    // ========== 데이터 로드 ==========
    async function loadData() {
      const id = getExhibitionId();
      
      if (!id) {
        document.getElementById('exhibition-content').innerHTML = `
          <div class="error-box">전시 ID가 없습니다.</div>
        `;
        return;
      }
      
      try {
        const [exhibition, reviews] = await Promise.all([
          fetchExhibition(id),
          fetchReviews(id)
        ]);
        
        renderExhibition(exhibition);
        renderReviews(reviews);
        
      } catch (error) {
        document.getElementById('exhibition-content').innerHTML = `
          <div class="error-box">${error.message}</div>
        `;
      }
    }
    
    // ========== 초기화 ==========
    loadData();
  </script>
</body>
</html>
